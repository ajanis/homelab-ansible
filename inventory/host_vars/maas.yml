---
maas_repository: ppa:maas/{{ maas_respository_version }}
maas_repository_version: "3.3"
maas_packages:
  - maas
  - postgresql
maas_admin: admin
maas_email: root@localhost
maas_postgres_user: pgmaas
maas_upstream_dns: 10.0.10.200
maas_host: "0.0.0.0"
maas_postgres_db: maas
maas_apikey_file: /tmp/maas_apikey
vault_maas_admin_sshkey: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  30323862616266343839326139336665636138383136656131393339353464333965323366356330
  3463643462383535313730323561343133313861393163610a376538303235623966336530356539
  64373261363934626435356632623363663130346334313464626165393562656339346237303634
  3732636565303738310a663937356331356235373035373665353166346330306335663534333363
  38636633343637323333366263336263623331333562633061666135373938626536613965633831
  31346138396332313064393836643630636432346666633236353764663038653163386537303433
  36303562333935313137663539613332663033393333336139343038326662383037313038363563
  30353961353665666631346635343866313761386438623533613032343565393064663566303337
  62376339613434653035663163656164313162616337343261363966653539303738616435653662
  33646366343161333734316633313836353830643735656133316139623734633938353863656264
  34396131376563313430376437393638306635383564303638316465323733343265663234623539
  34336331363732333739376435643961373338383063396263623161373961323832346163653163
  65306236643132363035316532313633323761383461666237343737326130383562363935313864
  64336132336336613366613436313232313965343039333164663937343765323837633066613161
  35363465306630386435343032356565313161326137343864616465316363343761363638383738
  38663136323261666330363639653632666130333530383532636139656334616332626333626430
  35373031363666623162353465663330333834343864626664313064373665613361393939313061
  62353432623861353831343063393234346561383836333630616530343831303534376162303632
  35316531306139346361373233346433393765653561393163633237386139653936306264633063
  34333764333631366561396432626332633138366565653836666465373637306262333039656664
  31626637376362626163643636646530626263323831626633393539623266633561623665643863
  35393537383365623763643534323139376630373634303133666631316437306439666238613865
  64323165313731306333373061326135323838316262373837376634636538306535663631393561
  64356130613631366139376130313461306532313631306134633937306665633031636265623432
  64326166333738666435306432666530656366613036353134633437303161313839313436353565
  64636361353630383764626261393064633963383463666363626161376666656134313832656263
  39353938323739316461646235643566306166386136376335643736313464666266303330326266
  63656363643836303061356366663330616331656564333538306564386139376264333261333333
  33373564303739633462386266646365343862653838336433613936356261613365613733313830
  33343465616534313461636562346261393366323933366338663562646363373464343964643063
  30643638333938316431353130323037336231616562616235356231653933333164336334663362
  39653839643566393461623365613135343135356561613239323131626665366539323939313532
  35633539313063303562626363643536333637366461386165343938336439376534386338356430
  62633333336631656538643364353166653439323534636661363566323236373934363764363466
  30643332366535643561343166303665373739373235313734633333386137653833393833333435
  38316636666262376264373661363066346163623133663765383764656137613338323632643964
  35376431333535643961383632306163613163326661323533353733383064303862646533633766
  32646532633031633033666466633863643636333236376638626464626163613763613133343566
  35376636326133363135326666393663303530366265396239346666663831626266613461343734
  39303764653661613138383238373766393231343936366235376133623531666332623633616435
  33633530373334363437616333623862313531626337373633333865613236393064666537346466
  62313431616664386539343836346433343131633735373437623139653131653565353764323938
  63383132643463656666636239623130386639653535333864333733316330643162626631383530
  30323966306436653235643831613734613563373134616362316364636265333838663334653463
  64616534633366396263316362343563643035363030356666666266366434626432333761333935
  35313731643336363833333039366638356262663266353238353732656565316239613966396139
  38323566393665643462363361346236303836396362656162353363383533316533333166313834
  31363336323236393863386538346465623464393636313335363865316263636132356533323666
  66303166356364393331626164616635633838613065373530623231353132313831623539386634
  39616531363230633233646262333261316535306536333763386435353839323731383034386434
  61623766613239333566613665666261656135343630323566663232663532633433663762633438
  64333332333236373263333430386465623638383131373562663634343662366464303232646336
  61656665363732623239663163386139343563666366376335656236323365653431636564663365
  66336232616639366537346265633133373138316563666564623333623237383761356362393834
  32646263623830326565643564666137633136666234646230303835383166343231663566306466
  35396662343930346639373039636235306337313831366639366361373237313165623931643733
  34633538363737323732366532383033616361623330323666373335316533356266386261613432
  63346466643335333736653966623433373234386630343065306134373030353836346232373239
  30653464633865623634313431326366656662643638393532643639633537633536663966323062
  39663538636438636239386361623064356636313837633237346338353565633062636230396539
  62353166656162396265303338626336646265383939346430373065643261613861396365643437
  37396636646434333739306266396537623630363936383136636666313132653931633862356161
  62373834356539396331346566633935333066363737326332333666373133393633633335316536
  31376633353638613664653962333739613464313335383833393238366236633236383834333530
  33353530383864333032333062633939323239316261653865656333323137303238666532623261
  62633838636135356535616230313461363739383337666162336265333833333636663863613334
  61653665633065636133306231373066333361346637663438323064343433313732636434313133
  63623763333932633462326666626330376534396262333731303831663633643065623931613564
  66373961383130656131383964386632363035326534613533643766616539363665303566383535
  31653764636265306665373136333237356139383062353135666230666562383239633134623835
  62386630393666383435383431626132383438383333363835393561653737303161346337396566
  63303264613163353564346439653966373834313964303664303763343939316539663934616463
  33396331353332383066306532323464656630613130666265616137303331366639376539643161
  30383939613638323863393933363134373235343234303336333132313863373432333738323038
  36343233323733313166363234323535313966376461313238373132343062383432616539666338
  39356466396339626133663239353261613531666239316565336134353361396162313963306539
  35363831316362363331393033626363353030343364306364396634363034303834393632636361
  64653037636261386362386461623637653766663364316664626463643730373438633338373232
  36373239643739623365393764393464303762383531313063303961633038623431313330356264
  38323061366464656230373332386466633135613238633165303964303137386665353636376664
  61633936366562663161656561666130613039376231323233313137333266653961356464383336
  62366362326161366361643636316161346165313165653532623266313233663365643137646363
  65396133333538666438393335393133646166363937373662663332656639656263626266346264
  35373230613430393831613839663631386231393631353231643337626134643864323330356233
  64356634626636376639393763373839383863613565643032656232333337316330656337303466
  61666336346236333565613364613730623066666339643738343939363332613865333239653339
  38313137326639623564356363656538303032313565393565363835326563396238343031343630
  38633833623335376364343235366265363561636535336562336435333366663137613835306466
  33333465373039613166303434393065636133633965633666616166363362313364396562386565
  34663261343137663561626531343736663736326464386363366266613632316337663836623662
  65396464343030643131343834303964303130323733343333376134343765366361643864643533
  33616261656463376231303331383964646333383262653230343033366539366466613638653036
  33616339393736326162323962343436646333643332653965653436643431383962346262626539
  32653763323863363536363066343065643765303661376332326634333835633765613636643538
  31363166356539306132613036636338343963306566663766376266303264323462633430633664
  63353564623630663636
vault_maas_postgres_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  36323463626639356435386230313962666266633831643732333038393464653464343639643933
  3837396331623230306639336536663464303163353537620a393162306539623161313434323033
  39323565313563666663616638663331646133353932666535383163656461613735616535663232
  6162303132643764380a333339646336336432356166316137373137623563313866393466353033
  3961

maas_cmd_createadmin: maas createadmin --username={{ maas_admin | default('admin') }} --email={{ maas_email }}
maas_cmd_generate_apikey: maas apikey --username={{ maas_admin | default('admin') }} > {{ maas_apikey_file }}
maas_cmd_cli_login: maas login {{ maas_admin | default('admin') }} {{ mass_init.url }} {{ maas_apikey_file }}
maas_cmd_set_dns: maas {{ maas_admin | default('admin') }} maas set-config name=upstream_dns value='{{ maas_upstream_dns }}'
maas_cmd_create_sshkeys: maas {{ maas_admin | default('admin') }} sshkeys create 'key={{ vault_maas_admin | default_sshkey }}'
maas_cmd_read_bootresources: "maas {{ maas_admin | default('admin') }} boot-resources read | jq -r '.[] | '(.name)\t(.architecture)''"
maas_cmd_select_bootresources: maas {{ maas_admin | default('admin') }} boot-source-selections create 1  > os='ubuntu' release='trusty' arches='amd64' subarches='*'
  > labels'*'
maas_cmd_import_bootresources: maas admin boot-resources import

maas_init_command: sudo maas init region+rack --database-uri 'postgres://{{ maas_postgres_user | default('admin') }}:{{ vault_maas_postgres_password | default('password')
  }}@{{ maas_host | default('localhost') }}/{{ maas_postgres_db | default('maas') }}'
maas_postgresql_commands:
  - create user {{ maas_postgres_user | default('admin') }} with encrypted password {{ vault_maas_postgres_password | default('password') }}
  - create database {{ maas_postgres_db | default('maas') }}
  - grant all privileges on database {{ maas_postgres_db | default('maas') }} to {{ maas_postgres_user | default('admin') }}

maas_postgresql_config: /etc/postgresql/10/main/pg_hba.conf
maas_postgresql_ext_perms: host {{ maas_postgres_user | default('admin') }} {{ vault_maas_postgres_password | default('password') }} 0/0 md5

telegraf_plugins_extra:
  - name: nginx
    options:
      urls:
        - https://maas.home.prettybaked.com/nginx_status
  - name: procstat
    options:
      pattern: nginx
      prefix: maas-http
  - name: procstat
    options:
      pattern: regiond
      prefix: maas-regiond
  - name: procstat
    options:
      pattern: rackd
      prefix: maas-rackd
  - name: procstat
    options:
      pattern: squid
      prefix: maas-proxy
  - name: procstat
    options:
      pattern: postgres
      prefix: maas-db
  - name: postgresql
    options:
      address: postgres://{{ maas_postgres_user | default('admin') }}:{{ vault_maas_postgres_password | default('password') }}@{{ maas_host | default('localhost')
        }}/{{ maas_postgres_db | default('maas') }}
      ignored_databases:
        - template0
        - template1
  - name: x509_cert
    options:
      timeout: 30s
      interval: 300s
      exclude_root_certs: "true"
      sources:
        - https://maas.home.prettybaked.com:443
